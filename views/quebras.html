<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Registro de Quebras</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>

  <header>
    <div><strong>Estoque do Supermercado</strong></div>
    <nav>
      <a href="/conferencia-estoque">ğŸ“‹ ConferÃªncia de Estoque</a>
      <a href="/conferencia-quebras">ğŸ“‰ ConferÃªncia de Quebras</a>
      <a href="/conferencia-saidas">ğŸ“ˆ ConferÃªncia de SaÃ­das</a>
      <a href="/alterar-senha">ğŸ” Alterar Senha</a>
      <span id="links-admin"></span>
    </nav>
    <button onclick="logout()" class="logout-btn">Sair</button>
  </header>

  <main>
    <a href="/" class="back-link">&larr; InÃ­cio</a>
    <h1>Registro de Quebras</h1>

    <form id="formQuebra">
      <div class="form-group">
        <label for="produto">Produto:</label>
        <select id="produto" required>
          <option value="">Selecione um produto</option>
        </select>
      </div>
      <div class="form-group">
        <input type="number" name="quantidade" placeholder="Quantidade Quebrada" required>
      </div>
      <div class="form-group">
        <input type="text" name="valor_quebra" id="valor_quebra" placeholder="Valor Total da Quebra (R$)" required>
      </div>
      <button type="submit">Registrar Quebra</button>
    </form>

    <script src="/js/main.js"></script>
    <script>
      async function carregarProdutos() {
        const res = await fetch('/api/produtos');
        const produtos = await res.json();
        const select = document.getElementById('produto');
        produtos.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.nome;
          select.appendChild(opt);
        });
      }

      document.getElementById('valor_quebra').addEventListener('input', e => {
        let v = e.target.value.replace(/\D/g, '');
        v = (parseFloat(v) / 100).toFixed(2);
        v = v.replace('.', ',');
        e.target.value = 'R$ ' + v;
      });

      document.getElementById('formQuebra').addEventListener('submit', async (e) => {
        e.preventDefault();
        const produto_id = document.getElementById('produto').value;
        const dados = Object.fromEntries(new FormData(e.target));
        dados.produto_id = produto_id;
        dados.valor_quebra = parseFloat(dados.valor_quebra.replace(/[^0-9,]/g, '').replace(',', '.'));

        const res = await fetch('/api/quebras', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(dados)
        });

        const r = await res.json();
        alert('Quebra registrada com ID: ' + r.id);
        e.target.reset();
      });

      carregarProdutos();
    </script>

    <script>
      const user = JSON.parse(localStorage.getItem('usuarioLogado')) || {};
      const linksAdmin = document.getElementById('links-admin');
      if (user.role === 'admin') {
        linksAdmin.innerHTML = `
          <a href="/cadastro">ğŸ“¦ Cadastro</a>
          <a href="/quebras">âŒ Quebras</a>
          <a href="/saidas">ğŸ’° SaÃ­das</a>
          <a href="/logs">ğŸ•µï¸ Logs</a>
          <a href="/painel-admin">ğŸ“Š Painel</a>
          <a href="/admin-criar-usuario">ğŸ‘¤ Novo UsuÃ¡rio</a>
        `;
      }
    </script>

  </main>

</body>
</html>
